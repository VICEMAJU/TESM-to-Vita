name: FASE 3 - Compilando OpenMW

on: [push, workflow_dispatch]

permissions:
  actions: read
  contents: write

jobs:
  build-game:
    runs-on: ubuntu-latest
    container: vitasdk/vitasdk:latest

    steps:
      - name: 1. Instalar Herramientas
        run: apk update && apk add --no-cache make cmake git pkgconf sed python3 g++ zip

      - name: 2. Descargar C√≥digo OpenMW (Tu Repo)
        uses: actions/checkout@v4

      - name: 3. üì• Descargar Motor Gr√°fico (Del Pasado)
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: build-osg.yml
          name: osg-vita-libs
          path: deps/osg

      - name: 4. ‚úçÔ∏è Inyectar Toolchain
        run: |
          cat <<EOF > vita.cmake
          set(CMAKE_SYSTEM_NAME Generic)
          set(CMAKE_SYSTEM_PROCESSOR arm)
          set(CMAKE_CROSSCOMPILING TRUE)
          set(CMAKE_C_COMPILER arm-vita-eabi-gcc)
          set(CMAKE_CXX_COMPILER arm-vita-eabi-g++)
          set(CMAKE_FIND_ROOT_PATH "\$ENV{VITASDK}/arm-vita-eabi")
          
          set(CMAKE_CXX_FLAGS "-O3 -D__vita__ -DPATH_MAX=4096 -DNO_WORDEXP")
          set(CMAKE_C_FLAGS "-O3 -D__vita__ -DPATH_MAX=4096 -DNO_WORDEXP")
          
          set(CMAKE_PREFIX_PATH "\${CMAKE_CURRENT_SOURCE_DIR}/deps/osg;\${CMAKE_CURRENT_SOURCE_DIR}/deps/mygui;\${CMAKE_CURRENT_SOURCE_DIR}/deps/lz4;\${CMAKE_CURRENT_SOURCE_DIR}/deps/icu;\${CMAKE_CURRENT_SOURCE_DIR}/deps/sqlite")
          EOF

      - name: 5. üèóÔ∏è Compilar Interfaz (MyGUI)
        run: |
          echo "Compilando MyGUI..."
          git clone --depth 1 https://github.com/MyGUI/mygui.git mygui_src
          mkdir mygui_build
          cd mygui_build
          cmake ../mygui_src \
            -DCMAKE_TOOLCHAIN_FILE="../vita.cmake" \
            -DCMAKE_INSTALL_PREFIX="../deps/mygui" \
            -DCMAKE_BUILD_TYPE=Release \
            -DMYGUI_RENDERSYSTEM=1 \
            -DMYGUI_BUILD_DEMOS=OFF \
            -DMYGUI_BUILD_TOOLS=OFF \
            -DMYGUI_BUILD_PLUGINS=OFF \
            -DMYGUI_USE_FREETYPE=OFF \
            -G "Unix Makefiles"
          make -j$(nproc)
          make install

      - name: 6. üèóÔ∏è Compilar LZ4
        run: |
          echo "Compilando LZ4..."
          git clone --depth 1 https://github.com/lz4/lz4.git lz4_src
          cd lz4_src/build/cmake
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE="../../../../vita.cmake" \
            -DCMAKE_INSTALL_PREFIX="../../../../deps/lz4" \
            -DBUILD_SHARED_LIBS=OFF \
            -DLZ4_BUILD_CLI=OFF \
            -DLZ4_BUILD_LEGACY_LZ4C=OFF \
            -G "Unix Makefiles"
          make -j$(nproc)
          make install

      - name: 7. üèóÔ∏è Compilar SQLite (EL FANTASMA)
        run: |
          echo "Compilando SQLite3..."
          wget https://www.sqlite.org/2023/sqlite-amalgamation-3420000.zip
          unzip sqlite-amalgamation-3420000.zip
          cd sqlite-amalgamation-3420000
          
          mkdir sys
          touch sys/ioctl.h
          
          arm-vita-eabi-gcc -O3 -D__vita__ -I. -DSQLITE_OMIT_WAL -DSQLITE_OMIT_LOAD_EXTENSION -c sqlite3.c -o sqlite3.o
          arm-vita-eabi-ar rcs libsqlite3.a sqlite3.o
          
          mkdir -p ../deps/sqlite/include
          mkdir -p ../deps/sqlite/lib
          cp sqlite3.h ../deps/sqlite/include/
          cp libsqlite3.a ../deps/sqlite/lib/
          echo "‚úÖ SQLite Listo"

      - name: 8. üèóÔ∏è Compilar ICU (EL MONSTRUO)
        run: |
          echo "Descargando ICU..."
          wget https://github.com/unicode-org/icu/releases/download/release-55-2/icu4c-55_2-src.tgz
          tar -xzf icu4c-55_2-src.tgz
          
          mkdir build-host
          cd build-host
          ../icu/source/runConfigureICU Linux
          make -j$(nproc)
          cd ..
          
          mkdir build-vita
          cd build-vita
          cp ../icu/source/config/mh-linux ../icu/source/config/mh-unknown
          export CC=arm-vita-eabi-gcc
          export CXX=arm-vita-eabi-g++
          ../icu/source/configure --host=arm-vita-eabi --prefix="$PWD/../deps/icu" \
            --with-cross-build="$PWD/../build-host" \
            --enable-static --disable-shared \
            --disable-dyload --disable-tools --disable-tests --disable-samples
          make -j$(nproc)
          make install

      - name: 9. Configurar OpenMW
        run: |
          git config --global --add safe.directory "*"
          
          # Lobotom√≠as habituales
          sed -i 's/find_package(FFmpeg REQUIRED/find_package(FFmpeg/g' CMakeLists.txt
          sed -i '/FFmpeg was not found/d' CMakeLists.txt
          sed -i '/Bullet does not uses double precision/d' CMakeLists.txt
          
          mkdir build
          cd build
          
          # --- AQU√ç EST√Å EL BOMBARDEO DE RUTAS ---
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE="../vita.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_OPENMW=ON \
            -DBUILD_OPENCS=OFF \
            -DBUILD_LUA=OFF \
            -DBUILD_WIZARD=OFF \
            -DBUILD_LAUNCHER=OFF \
            -DBUILD_ESSIMPORTER=OFF \
            -DBUILD_BSATOOL=OFF \
            -DBUILD_UNITTESTS=OFF \
            -DOPENMW_USE_SYSTEM_OSG=ON \
            -DOPENMW_USE_SYSTEM_MYGUI=ON \
            -DOPENMW_USE_SYSTEM_LZ4=ON \
            -DOPENMW_USE_FFMPEG=OFF \
            -DOPENMW_USE_DOUBLE_PRECISION=OFF \
            -DCMAKE_DISABLE_FIND_PACKAGE_FFmpeg=TRUE \
            -DCMAKE_DISABLE_FIND_PACKAGE_collada_dom=TRUE \
            -DBoost_USE_STATIC_LIBS=ON \
            -DBoost_USE_STATIC_RUNTIME=ON \
            -DOPENGL_INCLUDE_DIR="$VITASDK/arm-vita-eabi/include" \
            -DOPENGL_gl_LIBRARY="$VITASDK/arm-vita-eabi/lib/libGLESv2.a" \
            -DOPENGL_glu_LIBRARY="$VITASDK/arm-vita-eabi/lib/libGLESv2.a" \
            -DOPENTHREADS_LIBRARY="$(pwd)/../deps/osg/lib/libOpenThreads.a" \
            -DOPENTHREADS_LIBRARY_RELEASE="$(pwd)/../deps/osg/lib/libOpenThreads.a" \
            -DOPENTHREADS_INCLUDE_DIR="$(pwd)/../deps/osg/include" \
            -DSQLite3_INCLUDE_DIR="$(pwd)/../deps/sqlite/include" \
            -DSQLite3_LIBRARY="$(pwd)/../deps/sqlite/lib/libsqlite3.a" \
            -DCMAKE_INSTALL_PREFIX="./install" \
            -DCMAKE_INSTALL_BINDIR=bin \
            -DCMAKE_INSTALL_LIBDIR=lib \
            -DCMAKE_INSTALL_DATAROOTDIR=share \
            -DCMAKE_INSTALL_SYSCONFDIR=etc \
            -DBINDIR=bin \
            -DLIBDIR=lib \
            -DDATAROOTDIR=share \
            -DSYSCONFDIR=etc \
            -DMAN_PATH=share/man \
            -DDOCDIR=share/doc \
            -DGLOBAL_DATA_PATH="share" \
            -G "Unix Makefiles"

      - name: 10. Compilar OpenMW
        run: |
          cd build
          make -j$(nproc)
