name: Compilando OSG (Intento 7 - Amputacion OSC)

on: [push, workflow_dispatch]

jobs:
  build-osg:
    runs-on: ubuntu-latest
    container: vitasdk/vitasdk:latest

    steps:
      - name: 1. Instalar Herramientas
        run: |
          apk update && apk add --no-cache make cmake git pkgconf sed

      - name: 2. Descargar OpenSceneGraph
        run: git clone --depth 1 -b 3.6 https://github.com/OpenMW/osg.git osg_src

      - name: 3. ü©π PARCHEAR y AMPUTAR
        run: |
          echo "Aplicando parches..."
          
          # PARCHE 1: Eliminar stat64 (Cirug√≠a vital)
          sed -i 's/stat64/stat/g' osg_src/src/osgDB/FileUtils.cpp
          if [ -f osg_src/src/osgDB/FileNameUtils.cpp ]; then
             sed -i 's/stat64/stat/g' osg_src/src/osgDB/FileNameUtils.cpp
          fi

          # AMPUTACI√ìN: Borrar plugins in√∫tiles que dan error
          # OSC (Open Sound Control) falla por Endianness. No lo necesitamos.
          echo "Borrando plugin OSC..."
          rm -rf osg_src/src/osgPlugins/osc

          echo "‚úÖ C√≥digo listo."

      - name: 4. ‚úçÔ∏è Inyectar Toolchain
        run: |
          cat <<EOF > vita.cmake
          set(CMAKE_SYSTEM_NAME Generic)
          set(CMAKE_SYSTEM_PROCESSOR arm)
          set(CMAKE_CROSSCOMPILING TRUE)
          set(CMAKE_C_COMPILER arm-vita-eabi-gcc)
          set(CMAKE_CXX_COMPILER arm-vita-eabi-g++)
          set(CMAKE_FIND_ROOT_PATH "\$ENV{VITASDK}/arm-vita-eabi")
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          
          set(CMAKE_CXX_FLAGS "-O3 -D__vita__ -DPATH_MAX=4096 -DNO_WORDEXP")
          set(CMAKE_C_FLAGS "-O3 -D__vita__ -DPATH_MAX=4096 -DNO_WORDEXP")
          EOF

      - name: 5. Configurar OSG
        run: |
          mkdir osg_build
          cd osg_build
          
          cmake ../osg_src \
            -DCMAKE_TOOLCHAIN_FILE="../vita.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_OSG_APPLICATIONS=OFF \
            -DBUILD_OSG_EXAMPLES=OFF \
            -DOPENGL_PROFILE=GLES2 \
            -DOSG_WINDOWING_SYSTEM=None \
            -DOSG_GL1_AVAILABLE=OFF \
            -DOSG_GL2_AVAILABLE=OFF \
            -DOSG_GLES1_AVAILABLE=OFF \
            -DOSG_GLES2_AVAILABLE=ON \
            -DOSG_GL_DISPLAYLISTS_AVAILABLE=OFF \
            -DOPENTHREADS_ATOMIC_USE_MUTEX=ON \
            -DDYNAMIC_OPENTHREADS=OFF \
            -DDYNAMIC_OPENSCENEGRAPH=OFF \
            -DOPENGL_INCLUDE_DIR="$VITASDK/arm-vita-eabi/include" \
            -DOPENGL_gl_LIBRARY="$VITASDK/arm-vita-eabi/lib/libGLESv2.a" \
            -DEGL_INCLUDE_DIR="$VITASDK/arm-vita-eabi/include" \
            -DEGL_LIBRARY="$VITASDK/arm-vita-eabi/lib/libEGL.a" \
            -DSDL2_INCLUDE_DIR="$VITASDK/arm-vita-eabi/include/SDL2" \
            -DSDL2_LIBRARY="$VITASDK/arm-vita-eabi/lib/libSDL2.a" \
            -G "Unix Makefiles"

      - name: 6. Compilar
        run: |
          cd osg_build
          make -j$(nproc)

      - name: 7. Verificar √âxito
        run: ls -lh osg_build/lib/libosg.a
