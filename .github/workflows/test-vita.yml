name: Intento 6 - Creacion Manual del Toolchain

on: [push, workflow_dispatch]

jobs:
  build-mygui:
    runs-on: ubuntu-latest
    container: vitasdk/vitasdk:latest

    steps:
      - name: 1. Instalar Herramientas
        run: |
          # Probamos instalar make y cmake (seguro es Alpine Linux)
          apk update && apk add --no-cache make cmake git

      - name: 2. Descargar MyGUI
        run: git clone --depth 1 https://github.com/MyGUI/mygui.git mygui_src

      - name: 3. ✍️ CREAR Toolchain (Modo Dios)
        run: |
          # En lugar de bajarlo, lo escribimos nosotros ahora mismo.
          # Esto crea un archivo llamado 'vita.cmake' con la configuración perfecta.
          cat <<EOF > vita.cmake
          set(CMAKE_SYSTEM_NAME Generic)
          set(CMAKE_SYSTEM_PROCESSOR arm)
          set(CMAKE_CROSSCOMPILING TRUE)
          
          # Definimos los compiladores que ya vienen en el contenedor
          set(CMAKE_C_COMPILER arm-vita-eabi-gcc)
          set(CMAKE_CXX_COMPILER arm-vita-eabi-g++)
          
          # Le decimos dónde buscar las librerías del sistema
          set(CMAKE_FIND_ROOT_PATH "\$ENV{VITASDK}/arm-vita-eabi")
          
          # Reglas para no mezclar archivos de Linux con los de Vita
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          
          # Banderas extra para asegurar que funcione
          set(CMAKE_C_FLAGS "-Wno-attributes")
          set(CMAKE_CXX_FLAGS "-Wno-attributes")
          EOF
          
          echo "✅ Archivo vita.cmake creado manualmente."
          cat vita.cmake # Lo mostramos en pantalla para verificar

      - name: 4. Configurar
        run: |
          mkdir mygui_build
          cd mygui_build

          # Usamos nuestro archivo recién creado
          cmake ../mygui_src \
            -DCMAKE_TOOLCHAIN_FILE="../vita.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DMYGUI_RENDERSYSTEM=1 \
            -DMYGUI_BUILD_DEMOS=OFF \
            -DMYGUI_BUILD_TOOLS=OFF \
            -DMYGUI_BUILD_PLUGINS=OFF \
            -DMYGUI_USE_FREETYPE=OFF \
            -G "Unix Makefiles"

      - name: 5. Compilar
        run: |
          cd mygui_build
          make -j$(nproc)

      - name: 6. Verificar Éxito
        run: ls -lh mygui_build/lib/libMyGUIEngine.a
