name: FASE 3 - Compilando OpenMW

on: [push, workflow_dispatch]

permissions:
  actions: read
  contents: write

jobs:
  build-game:
    runs-on: ubuntu-latest
    container: vitasdk/vitasdk:latest

    steps:
      - name: 1. Instalar Herramientas
        run: apk update && apk add --no-cache make cmake git pkgconf sed python3 g++ zip findutils

      - name: 2. Descargar C√≥digo OpenMW (Tu Repo)
        uses: actions/checkout@v4

      - name: 3. üì• Descargar Motor Gr√°fico (Del Pasado)
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: build-osg.yml
          name: osg-vita-libs
          path: deps/osg

      - name: 4. ‚úçÔ∏è Inyectar Toolchain (Con Fix de OpenGL)
        run: |
          cat <<EOF > vita.cmake
          set(CMAKE_SYSTEM_NAME Generic)
          set(CMAKE_SYSTEM_PROCESSOR arm)
          set(CMAKE_CROSSCOMPILING TRUE)
          set(CMAKE_C_COMPILER arm-vita-eabi-gcc)
          set(CMAKE_CXX_COMPILER arm-vita-eabi-g++)
          set(CMAKE_FIND_ROOT_PATH "\$ENV{VITASDK}/arm-vita-eabi")
          
          # AQUI ESTA EL FIX: Definimos GLclampd y GLdouble manualmente
          set(CMAKE_CXX_FLAGS "-O3 -D__vita__ -DPATH_MAX=4096 -DNO_WORDEXP -DGLclampd=double -DGLdouble=double")
          set(CMAKE_C_FLAGS "-O3 -D__vita__ -DPATH_MAX=4096 -DNO_WORDEXP -DGLclampd=double -DGLdouble=double")
          
          set(CMAKE_PREFIX_PATH "\${CMAKE_CURRENT_SOURCE_DIR}/deps/osg;\${CMAKE_CURRENT_SOURCE_DIR}/deps/mygui;\${CMAKE_CURRENT_SOURCE_DIR}/deps/lz4;\${CMAKE_CURRENT_SOURCE_DIR}/deps/icu;\${CMAKE_CURRENT_SOURCE_DIR}/deps/sqlite")
          EOF

      - name: 5. üèóÔ∏è Compilar Interfaz (MyGUI)
        run: |
          echo "Compilando MyGUI..."
          git clone --depth 1 https://github.com/MyGUI/mygui.git mygui_src
          mkdir mygui_build
          cd mygui_build
          cmake ../mygui_src \
            -DCMAKE_TOOLCHAIN_FILE="../vita.cmake" \
            -DCMAKE_INSTALL_PREFIX="../deps/mygui" \
            -DCMAKE_BUILD_TYPE=Release \
            -DMYGUI_RENDERSYSTEM=1 \
            -DMYGUI_BUILD_DEMOS=OFF \
            -DMYGUI_BUILD_TOOLS=OFF \
            -DMYGUI_BUILD_PLUGINS=OFF \
            -DMYGUI_USE_FREETYPE=OFF \
            -G "Unix Makefiles"
          make -j$(nproc)
          make install

      - name: 6. üèóÔ∏è Compilar LZ4
        run: |
          echo "Compilando LZ4..."
          git clone --depth 1 https://github.com/lz4/lz4.git lz4_src
          cd lz4_src/build/cmake
          mkdir build
          cd build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE="../../../../vita.cmake" \
            -DCMAKE_INSTALL_PREFIX="../../../../deps/lz4" \
            -DBUILD_SHARED_LIBS=OFF \
            -DLZ4_BUILD_CLI=OFF \
            -DLZ4_BUILD_LEGACY_LZ4C=OFF \
            -G "Unix Makefiles"
          make -j$(nproc)
          make install

      - name: 7. üèóÔ∏è Compilar SQLite (EL FANTASMA)
        run: |
          echo "Compilando SQLite3..."
          wget https://www.sqlite.org/2023/sqlite-amalgamation-3420000.zip
          unzip sqlite-amalgamation-3420000.zip
          cd sqlite-amalgamation-3420000
          
          mkdir sys
          touch sys/ioctl.h
          
          arm-vita-eabi-gcc -O3 -D__vita__ -I. -DSQLITE_OMIT_WAL -DSQLITE_OMIT_LOAD_EXTENSION -c sqlite3.c -o sqlite3.o
          arm-vita-eabi-ar rcs libsqlite3.a sqlite3.o
          
          mkdir -p ../deps/sqlite/include
          mkdir -p ../deps/sqlite/lib
          cp sqlite3.h ../deps/sqlite/include/
          cp libsqlite3.a ../deps/sqlite/lib/
          echo "‚úÖ SQLite Listo"

      - name: 8. üèóÔ∏è Compilar ICU (EL MONSTRUO)
        run: |
          echo "Descargando ICU..."
          wget https://github.com/unicode-org/icu/releases/download/release-55-2/icu4c-55_2-src.tgz
          tar -xzf icu4c-55_2-src.tgz
          
          mkdir build-host
          cd build-host
          ../icu/source/runConfigureICU Linux
          make -j$(nproc)
          cd ..
          
          mkdir build-vita
          cd build-vita
          cp ../icu/source/config/mh-linux ../icu/source/config/mh-unknown
          export CC=arm-vita-eabi-gcc
          export CXX=arm-vita-eabi-g++
          ../icu/source/configure --host=arm-vita-eabi --prefix="$PWD/../deps/icu" \
            --with-cross-build="$PWD/../build-host" \
            --enable-static --disable-shared \
            --disable-dyload --disable-tools --disable-tests --disable-samples
          make -j$(nproc)
          make install

      - name: 9. üöë REPARACIONES AUTOM√ÅTICAS
        run: |
          echo "‚ö†Ô∏è Iniciando reparaciones de entorno..."
          
          # 1. REPARAR OPENTHREADS
          git clone --depth 1 --branch OpenSceneGraph-3.6.5 https://github.com/openscenegraph/OpenSceneGraph.git osg_temp
          FOUND_HEADER=$(find osg_temp -name "ReentrantMutex" | head -n 1)
          SOURCE_DIR=$(dirname "$FOUND_HEADER")
          mkdir -p deps/osg/include/OpenThreads
          cp -r "$SOURCE_DIR/"* deps/osg/include/OpenThreads/
          
          echo "#ifndef _OPENTHREADS_CONFIG" > deps/osg/include/OpenThreads/Config
          echo "#define _OPENTHREADS_CONFIG" >> deps/osg/include/OpenThreads/Config
          echo "#define _OPENTHREADS_ATOMIC_USE_GCC_BUILTINS" >> deps/osg/include/OpenThreads/Config
          echo "#define _OPENTHREADS_EXPORTS" >> deps/osg/include/OpenThreads/Config
          echo "#endif" >> deps/osg/include/OpenThreads/Config
          echo "#define OPENTHREADS_MAJOR_VERSION 3" > deps/osg/include/OpenThreads/Version
          rm -rf osg_temp
          
          # 2. INSTALAR POLYFILL PARA <format>
          git clone --depth 1 https://github.com/fmtlib/fmt.git deps/fmt
          mkdir -p deps/fmt/include/std_shim
          cat <<EOF > deps/fmt/include/std_shim/format
          #pragma once
          #include <fmt/core.h>
          #include <fmt/format.h>
          namespace std {
              using fmt::format;
              using fmt::vformat;
              using fmt::make_format_args;
          }
          EOF
          
          # 3. SCRIPT DE PARCHEO (Solo lo necesario que NO has hecho a mano)
          echo "üîß Ejecutando parches Python..."
          python3 -c '
          import sys
          import re

          # --- PARCHEAR LINUXPATH.CPP (Desactivar wordexp) ---
          try:
              lpc_path = "components/files/linuxpath.cpp"
              with open(lpc_path, "r") as f: content = f.read()
              
              # Permitir compilaci√≥n en Vita
              content = content.replace("defined(__linux__)", "defined(__linux__) || defined(__vita__)")
              
              # Envolver el include de wordexp
              if "#include <wordexp.h>" in content:
                  content = content.replace("#include <wordexp.h>", "#ifndef __vita__\\n#include <wordexp.h>\\n#endif")
              
              # Hackear la funci√≥n wordexp
              hack_wordexp = """
          #ifdef __vita__
          #include <iostream>
          #include <cstring>
          namespace {
              struct wordexp_t { char **we_wordv; int we_wordc; };
              int wordexp(const char *s, wordexp_t *p, int flags) {
                  p->we_wordc = 1;
                  p->we_wordv = new char*[2];
                  p->we_wordv[0] = strdup(s);
                  p->we_wordv[1] = NULL;
                  return 0;
              }
              void wordfree(wordexp_t *p) {
                  if(p->we_wordv) { free(p->we_wordv[0]); delete[] p->we_wordv; }
              }
          }
          #endif
          """
              if "struct wordexp_t" not in content:
                  content = re.sub(r"(#include <.*>(\s)*)+", r"\g<0>\n" + hack_wordexp, content, 1)
              
              with open(lpc_path, "w") as f: f.write(content)
              print("‚úÖ linuxpath.cpp parcheado autom√°ticamente.")
          except Exception as e:
              print(f"‚ùå Error parcheando linuxpath.cpp: {e}")

          # --- FIXES DE STRING_VIEW RESTANTES ---
          # Solo los archivos que aun no has editado a mano
          files_to_patch = [
              "components/l10n/messagebundles.hpp",
              "components/l10n/messagebundles.cpp",
              "components/lua/inputactions.cpp",
              "components/lua/inputactions.hpp"
          ]
          for file_path in files_to_patch:
              try:
                  with open(file_path, "r") as f: content = f.read()
                  content = content.replace("mBundles.find(std::string_view(loc.getName()))", "mBundles.find(std::string(loc.getName()))")
                  content = content.replace("bundles.find(localeName)", "bundles.find(std::string(localeName))")
                  content = content.replace("mGmsts.find(key)", "mGmsts.find(std::string(key))")
                  content = content.replace("iter->second.find(key)", "iter->second.find(std::string(key))")
                  content = content.replace("!mGmsts.contains(key)", "mGmsts.count(std::string(key)) == 0")
                  content = content.replace("mGmsts.contains(key)", "mGmsts.count(std::string(key)) > 0")
                  content = content.replace("mBundles.find(localeName)", "mBundles.find(std::string(localeName))")
                  content = content.replace("mIds.find(key)", "mIds.find(std::string(key))")
                  content = content.replace("mIds.find(actionKey)", "mIds.find(std::string(actionKey))")
                  with open(file_path, "w") as f: f.write(content)
                  print(f"‚úÖ {file_path} parcheado.")
              except FileNotFoundError: pass
          '
          # ----------------------------------------------------

      - name: 10. Configurar OpenMW
        run: |
          git config --global --add safe.directory "*"
          
          # Lobotom√≠as habituales
          sed -i 's/find_package(FFmpeg REQUIRED/find_package(FFmpeg/g' CMakeLists.txt
          sed -i '/FFmpeg was not found/d' CMakeLists.txt
          sed -i '/Bullet does not uses double precision/d' CMakeLists.txt
          sed -i '/osg-ffmpeg-videoplayer/d' extern/CMakeLists.txt
          echo "" > extern/osg-ffmpeg-videoplayer/CMakeLists.txt

          # Cirug√≠a Python (Rutas y Configuraci√≥n)
          python3 -c '
          import sys
          import os
          replacements = {
              "${BINDIR}": "bin", "${LIBDIR}": "lib", "${DOCDIR}": "share/doc",
              "${MANDIR}": "share/man", "${SYSCONFDIR}": "etc", "${DATAROOTDIR}": "share",
              "${GLOBAL_DATA_PATH}": "share", "${ICONDIR}": "share/icons"
          }
          with open("CMakeLists.txt", "r") as f: content = f.read()
          for key, value in replacements.items(): content = content.replace(key, value)
          
          # Inyecci√≥n de Includes (OSG + FMT Shim)
          cwd = os.getcwd()
          include_injection = f"include_directories({cwd}/deps/osg/include {cwd}/deps/fmt/include {cwd}/deps/fmt/include/std_shim)\n"
          content = include_injection + content
          
          with open("CMakeLists.txt", "w") as f: f.write(content)
          '
          
          mkdir build
          cd build
          
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE="../vita.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_OPENMW=ON \
            -DBUILD_OPENCS=OFF \
            -DBUILD_LUA=OFF \
            -DBUILD_WIZARD=OFF \
            -DBUILD_LAUNCHER=OFF \
            -DBUILD_ESSIMPORTER=OFF \
            -DBUILD_BSATOOL=OFF \
            -DBUILD_UNITTESTS=OFF \
            -DOPENMW_USE_SYSTEM_OSG=ON \
            -DOPENMW_USE_SYSTEM_MYGUI=ON \
            -DOPENMW_USE_SYSTEM_LZ4=ON \
            -DOPENMW_USE_FFMPEG=OFF \
            -DOPENMW_USE_DOUBLE_PRECISION=OFF \
            -DCMAKE_DISABLE_FIND_PACKAGE_FFmpeg=TRUE \
            -DCMAKE_DISABLE_FIND_PACKAGE_collada_dom=TRUE \
            -DBoost_USE_STATIC_LIBS=ON \
            -DBoost_USE_STATIC_RUNTIME=ON \
            -DOPENGL_INCLUDE_DIR="$VITASDK/arm-vita-eabi/include" \
            -DOPENGL_gl_LIBRARY="$VITASDK/arm-vita-eabi/lib/libGLESv2.a" \
            -DOPENGL_glu_LIBRARY="$VITASDK/arm-vita-eabi/lib/libGLESv2.a" \
            -DOPENTHREADS_LIBRARY="$(pwd)/../deps/osg/lib/libOpenThreads.a" \
            -DOPENTHREADS_LIBRARY_RELEASE="$(pwd)/../deps/osg/lib/libOpenThreads.a" \
            -DOPENTHREADS_INCLUDE_DIR="$(pwd)/../deps/osg/include" \
            -DSQLite3_INCLUDE_DIR="$(pwd)/../deps/sqlite/include" \
            -DSQLite3_LIBRARY="$(pwd)/../deps/sqlite/lib/libsqlite3.a" \
            -DCMAKE_INSTALL_PREFIX="./install" \
            -G "Unix Makefiles"

      - name: 11. Compilar OpenMW
        run: |
          cd build
          export CPATH="$PWD/../deps/osg/include:$PWD/../deps/fmt/include:$PWD/../deps/fmt/include/std_shim:$CPATH"
          make -j$(nproc)
