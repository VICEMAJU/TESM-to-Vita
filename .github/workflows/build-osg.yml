name: Compilando OSG (Intento 4 - Parche PATH_MAX)

on: [push, workflow_dispatch]

jobs:
  build-osg:
    runs-on: ubuntu-latest
    container: vitasdk/vitasdk:latest

    steps:
      - name: 1. Instalar Herramientas
        run: |
          apk update && apk add --no-cache make cmake git pkgconf

      - name: 2. Descargar OpenSceneGraph
        run: git clone --depth 1 -b 3.6 https://github.com/OpenMW/osg.git osg_src

      - name: 3. ✍️ Inyectar Toolchain (Con Parche)
        run: |
          cat <<EOF > vita.cmake
          set(CMAKE_SYSTEM_NAME Generic)
          set(CMAKE_SYSTEM_PROCESSOR arm)
          set(CMAKE_CROSSCOMPILING TRUE)
          set(CMAKE_C_COMPILER arm-vita-eabi-gcc)
          set(CMAKE_CXX_COMPILER arm-vita-eabi-g++)
          set(CMAKE_FIND_ROOT_PATH "\$ENV{VITASDK}/arm-vita-eabi")
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          
          # AQUÍ ESTÁ EL ARREGLO:
          # Agregamos -DPATH_MAX=4096 para que el compilador sepa el tamaño
          # Agregamos -DNO_WORDEXP porque Vita tampoco tiene esa función
          set(CMAKE_CXX_FLAGS "-O3 -D__vita__ -DPATH_MAX=4096 -DNO_WORDEXP")
          set(CMAKE_C_FLAGS "-O3 -D__vita__ -DPATH_MAX=4096 -DNO_WORDEXP")
          EOF

      - name: 4. Configurar OSG
        run: |
          mkdir osg_build
          cd osg_build
          
          cmake ../osg_src \
            -DCMAKE_TOOLCHAIN_FILE="../vita.cmake" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_OSG_APPLICATIONS=OFF \
            -DBUILD_OSG_EXAMPLES=OFF \
            -DOPENGL_PROFILE=GLES2 \
            -DOSG_WINDOWING_SYSTEM=None \
            -DOSG_GL1_AVAILABLE=OFF \
            -DOSG_GL2_AVAILABLE=OFF \
            -DOSG_GLES1_AVAILABLE=OFF \
            -DOSG_GLES2_AVAILABLE=ON \
            -DOSG_GL_DISPLAYLISTS_AVAILABLE=OFF \
            -DOPENTHREADS_ATOMIC_USE_MUTEX=ON \
            -DDYNAMIC_OPENTHREADS=OFF \
            -DDYNAMIC_OPENSCENEGRAPH=OFF \
            -DOPENGL_INCLUDE_DIR="$VITASDK/arm-vita-eabi/include" \
            -DOPENGL_gl_LIBRARY="$VITASDK/arm-vita-eabi/lib/libGLESv2.a" \
            -DEGL_INCLUDE_DIR="$VITASDK/arm-vita-eabi/include" \
            -DEGL_LIBRARY="$VITASDK/arm-vita-eabi/lib/libEGL.a" \
            -DSDL2_INCLUDE_DIR="$VITASDK/arm-vita-eabi/include/SDL2" \
            -DSDL2_LIBRARY="$VITASDK/arm-vita-eabi/lib/libSDL2.a" \
            -G "Unix Makefiles"

      - name: 5. Compilar
        run: |
          cd osg_build
          make -j$(nproc)

      - name: 6. Verificar Éxito
        run: ls -lh osg_build/lib/libosg.a
